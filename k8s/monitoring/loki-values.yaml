# Valores para instalar Loki Stack con Helm
# Uso: helm install loki grafana/loki-stack -n logging --create-namespace -f k8s/monitoring/loki-values.yaml

# Configuraci贸n de Loki
loki:
  enabled: true
  persistence:
    enabled: true
    size: 50Gi
    storageClassName: fast-ssd
  resources:
    requests:
      memory: 1Gi
      cpu: 500m
    limits:
      memory: 2Gi
      cpu: 1000m
  config:
    schema_config:
      configs:
      - from: 2024-01-01
        store: boltdb-shipper
        object_store: filesystem
        schema: v11
        index:
          prefix: index_
          period: 24h
    storage_config:
      boltdb_shipper:
        active_index_directory: /loki/boltdb-shipper-active
        cache_location: /loki/boltdb-shipper-cache
        shared_store: filesystem
      filesystem:
        directory: /loki/chunks
    limits_config:
      ingestion_rate_mb: 10
      ingestion_burst_size_mb: 20
      max_query_length: 0s
      max_query_parallelism: 32
      max_streams_per_user: 10000
      max_line_size: 256KB
      reject_old_samples: true
      reject_old_samples_max_age: 168h

# Configuraci贸n de Promtail (recolector de logs)
promtail:
  enabled: true
  config:
    clients:
    - url: http://loki:3100/loki/api/v1/push
    scrapeConfigs:
    - job_name: kubernetes-pods
      kubernetes_sd_configs:
      - role: pod
      pipeline_stages:
      - docker: {}
      relabel_configs:
      - source_labels:
        - __meta_kubernetes_pod_node_name
        target_label: __host__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - action: replace
        replacement: $1
        separator: /
        source_labels:
        - __meta_kubernetes_namespace
        - __meta_kubernetes_pod_name
        target_label: job
      - action: replace
        source_labels:
        - __meta_kubernetes_namespace
        target_label: namespace
      - action: replace
        source_labels:
        - __meta_kubernetes_pod_name
        target_label: pod
      - action: replace
        source_labels:
        - __meta_kubernetes_pod_container_name
        target_label: container
      - replacement: /var/log/pods/*$1/*.log
        separator: /
        source_labels:
        - __meta_kubernetes_pod_uid
        - __meta_kubernetes_pod_container_name
        target_label: __path__

# Configuraci贸n de Grafana (si se instala junto con Loki)
grafana:
  enabled: true
  adminUser: admin
  adminPassword: admin123  # Cambiar en producci贸n
  persistence:
    enabled: true
    size: 10Gi
    storageClassName: fast-ssd
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
      - name: Loki
        type: loki
        access: proxy
        url: http://loki:3100
        isDefault: true
        jsonData:
          maxLines: 1000

